<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/social-icons.html">

<link rel="import" href="bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="bower_components/paper-styles/paper-styles.html">
<link rel="import" href="bower_components/paper-material/paper-material.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <googleplus-timeline></googleplus-timeline>

@group Seed Elements
@element googleplus-timeline
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="googleplus-timeline">

    <style is="custom-style">
    :host {
      display: inline-block;
      --google-events-width: 450px;
      --google-events-height: 450px;
      font-family: helvetica, arial, nimbussansl, liberationsans, freesans, clean, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color:#2e2e2e;
    }

    paper-header-panel {
      width: var(--google-events-width);
      height: var(--google-events-height);
      @apply(--shadow-elevation-3dp);
      border-radius: 8px;
    }
    div.paper-header {
      height: 60px;
      font-size: 20px;
      text-align: center;
      line-height: 60px;
      padding: 0 10px;
      color: white;
      transition: height 0.2s;
      border-top-left-radius: 3px;
      border-top-right-radius: 3px;
      background-color: var(--google-red-500);
    }
    div.paper-header iron-icon {
      border-radius: 5px;
      width: 40px;
      height: 40px;
    }
    .title {
      font-weight: bold;
      font-size: 1.3em;
    }
    .post {
      min-height: 100px;
      padding: 8px;
      border-radius: 3px;
      font-size:14px;
      background: rgb(238,238,238);
      background: -moz-linear-gradient(top,  rgba(238,238,238,1) 0%, rgba(233,233,233,1) 52%, rgba(238,238,238,1) 100%);
      background: -webkit-linear-gradient(top,  rgba(238,238,238,1) 0%,rgba(233,233,233,1) 52%,rgba(238,238,238,1) 100%);
      background: linear-gradient(to bottom,  rgba(238,238,238,1) 0%,rgba(233,233,233,1) 52%,rgba(238,238,238,1) 100%);
      filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#eeeeee', endColorstr='#eeeeee',GradientType=0 );
    }
    .postShadow{
      margin: 15px 8px;
    }
    paper-button {
      background-color:#9e9e9e;
      text-transform: none;
      color: #444;
      margin:0;
      font-size: 14px;
    }
    .header .name {
      margin: auto 12px;      
    }
    .header iron-icon {
      width: 40px;
      height: 40px;
    }
    .header iron-icon /deep/ img {
      border-radius: 50%;
    }
    .header .date {
      font-size:11px;
      padding-top: 10px;
    }
    a {
      text-decoration: none;
      /*color: #1e71bf;*/
      color: black;
      font-weight: bold;
    }
    a:hover {
      color: var(--google-blue-300);
    }
    .post > .content {
      margin: 10px 3px;
    }
    #stats_count{
      color: var(--google-grey-700);
      /*margin-top: 10px;
      margin-bottom: 10px;*/
      font-weight: bold;
      font-size: 15px;
      padding-right: 10px;
      padding-left: 3px;
    }
    .share_icon{
      width: 15px;
      height: 15px;
      padding-left: 10px;
    }
    #likeContainer span {
      vertical-align: -1px;
      margin-left: -5px;
      margin-top: 20px;  
    }
    .text{
      padding: 15px;
    }
    .flex{
      padding-top: 10px;
    }
    .attached_photo{
      width: 380px;
      height: auto;
    }
    #article_title{
      font-weight: normal;
      color: var(--google-grey-900);
    }
    #article_title:hover{
      color: var(--google-blue-300);
    }
    </style>

  <template id="template">
    <iron-ajax
               id="requestFollowing"
               url="https://www.googleapis.com/plus/v1/people/me/people/visible"
               method="GET"
               handleAs='json'
               on-response="_responseFollowings"
               >
    </iron-ajax>

    <iron-ajax
               id="requestPosts"
               url="{{request_posts_url}}"
               method="GET"
               handleAs='json'
               on-response="_responsePosts"
               >
    </iron-ajax>

      <paper-header-panel mode="waterfall" class="red">
        <div class="paper-header">
          <div><b>Google+</b></div>
        </div>

        <div class="content">
          <template is="dom-repeat" items="{{timeline_posts}}" sort="_sortPosts" >
            <paper-material elevation="2" class="postShadow">
              <!-- Google+ POST -->
              <div class="post">
                <!-- HEADER: user's avatar, user identifier and time information -->
                <div class="header horizontal layout">
                  <iron-icon src="{{item.actor.image.url}}" class="userAvatarPost"></iron-icon>
                  <div class="flex"><a href="{{item.actor.url}}" target="_blank" class="name"> {{item.actor.displayName}}</a>
                  </div>
                  <span class="date"><a href="{{item.url}}" target="_blank" class="name"> {{item.published_pretty}}</a></span>
                </div>


                <!-- BODY: text and details about the post itself -->
                  <!-- post content -->
                  <template is="dom-if" if="{{_isSharedPost(item)}}">
                    <a href="{{item.object.actor.url}}" target="_blank">{{item.object.actor.displayName}}</a> 
                    <a href="{{item.url}}" target="_blank"> has shared first:</a> 
                  </template>

                  <div class="text" inner-h-t-m-l="{{item.object.content}}"></div>
                  <!-- post attachments -->
                  <template is="dom-if" if="{{item.object.attachments}}">
                    <p>  
                    Video: {{_hasAttachment(item,'video')}}
                    Photo: {{_hasAttachment(item,'photo')}}
                    Article: {{_hasAttachment(item,'article')}}
                    Album: {{_hasAttachment(item,'album')}}</p>

                    <!-- post video attachment (if any) -->
                    <template is="dom-if" if="{{_hasVideoAttachment(item)}}">
                      <iframe id="video" type="text/html" width="380" height="285" frameBorder="0"
                       src="{{item.object.attachments.0.embed.url}}">
                      </iframe>                 
                    </template>

                    <!-- post photo attachment (if any) -->
                    <template is="dom-if" if="{{_hasAttachment(item,'photo')}}">
                      <span class="attached_photo_section">
                        <a href="{{item.object.attachments.0.url}}" target="_blank" >
                          <img class="attached_photo" src="{{item.object.attachments.0.image.url}}">
                        </a>
                      </span>
                    </template>

                    <!-- Link/article attachment (if any) -->
                    <template is="dom-if" if="{{_hasAttachment(item,'article')}}">
                      <a href="{{item.object.attachments.0.url}}" target="_blank" >
                        <template is="dom-if" if="{{item.object.attachments.0.image.url}}">
                          <img class="attached_photo" src="{{item.object.attachments.0.image.url}}">
                        </template>
                        <p id="article_title"> {{item.object.attachments.0.displayName}} </p>
                      </a>
                      <p id="article_subtitle"> {{item.object.attachments.0.content}} </p>
                    </template>

                    <!-- Album attachment (if any) -->
                    <template is="dom-if" if="{{_hasAttachment(item,'album')}}">
                      <!-- TODO -->
                        <a href="{{item.object.attachments.0.url}}"><p id="album-title">{{item.object.attachments.0.displayName}}</p></a>
                        <!-- Shows up to 4 captions of the album -->
                        <template is="dom-if" if="{{item.object.attachments.0.thumbnails.0.image.url}}">
                          <a href="{{item.object.attachments.0.thumbnails.0.url}}">
                            <img src="{{item.object.attachments.0.thumbnails.0.image.url}}" 
                            height="{{item.object.attachments.0.thumbnails.0.image.height}}" 
                            width="{{item.object.attachments.0.thumbnails.0.image.width}}">
                          </a>
                        </template>
                        
                        <template is="dom-if" if="{{item.object.attachments.0.thumbnails.1.image.url}}">
                          <a href="{{item.object.attachments.0.thumbnails.1.url}}">
                            <img src="{{item.object.attachments.0.thumbnails.1.image.url}}" 
                            height="{{item.object.attachments.0.thumbnails.1.image.height}}"
                            width="{{item.object.attachments.0.thumbnails.1.image.width}}">
                          </a>
                        </template>

                        <template is="dom-if" if="{{item.object.attachments.0.thumbnails.2.image.url}}">
                          <a href="{{item.object.attachments.0.thumbnails.2.url}}">
                            <img src="{{item.object.attachments.0.thumbnails.2.image.url}}" 
                            height="{{item.object.attachments.0.thumbnails.2.image.height}}"
                            width="{{item.object.attachments.0.thumbnails.2.image.width}}">
                          </a>
                        </template>
                        
                        <template is="dom-if" if="{{item.object.attachments.0.thumbnails.3.image.url}}">
                          <a href="{{item.object.attachments.0.thumbnails.3.url}}">
                            <img src="{{item.object.attachments.0.thumbnails.3.image.url}}" 
                            height="{{item.object.attachments.0.thumbnails.3.image.height}}"
                            width="{{item.object.attachments.0.thumbnails.3.image.width}}">
                          </a>
                        </template>
                      
                    </template>
                  </template>
                <!-- FOOTER: info about #+1's and #replies to the post -->
                <div id="likeContainer">

                  <iron-icon class="share_icon" icon="add"></iron-icon> 
                  <span id="stats_count">{{item.object.plusoners.totalItems}}</span>

                  <iron-icon class="share_icon" icon="reply"></iron-icon> 
                  <span id="stats_count">{{item.object.replies.totalItems}}</span>

                  <iron-icon class="share_icon" icon="social:share"></iron-icon> 
                  <span id="stats_count">{{item.object.resharers.totalItems}}</span>
            </div>
              </div>
            </paper-material>
          </template>
        </div>
      </paper-header-panel>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'googleplus-timeline',

    properties: {
        /**
       * Describes the api-key of the application
       *
       * @type {{name: string}}
       */
        token: {
          type: String,
          reflectToAttribute: true,
          notify: true
        },

        timeline_posts: {
          type: Object,
          value: []
        },

        following_user_id: {
          type: String,
          value: ""
        },

        request_posts_url: {
          type: String,
          computed: "_getRequestPostsURL(following_user_id)"
        },
        contador: {
          type: Number,
          value: 0
        }
    },

    _responseFollowings: function(event, detail){
      //We generate an ajax request to get the post published by the authenticated user
      this.following_user_id = "me";
      this.$.requestPosts.generateRequest();
      //We generate an ajax request for each user that the authenticated user follows 
      for (i=0;i<detail.response.items.length;i++) {
        this.following_user_id = detail.response.items[i].id;
        this.$.requestPosts.generateRequest();
      }
    },

    _getRequestPostsURL: function(user_id){
      return "https://www.googleapis.com/plus/v1/people/" + user_id + "/activities/public"
    },

    _responsePosts: function(event, detail){
      //Append all user posts to the user timeline 
      for(i=0; i<detail.response.items.length; i++){
        this.push('timeline_posts', detail.response.items[i]);
        //We transform datestamps to a more manageable format of every post received
        this._changeTime(this.timeline_posts.length - 1);
        // console.log(this.timeline_posts[i]);
      }
            
    },

    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
      if (this.token) {
          this.$.requestFollowing.setAttribute("headers", '{"Authorization":"Bearer '+ this.token + '"}');
          this.$.requestPosts.setAttribute("headers", '{"Authorization":"Bearer '+ this.token + '"}');
          this.$.requestFollowing.generateRequest();
        }
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior

    /**
     * The `googleplus-timeline-lasers` event is fired whenever `fireLasers` is called.
     *
     * @event googleplus-timeline-lasers
     * @detail {{sound: String}}
     */

    /**
     * Sometimes it's just nice to say hi.
     *
     * @param {string} greeting A positive greeting.
     * @return {string} The full greeting.
     */
    sayHello: function(greeting) {
      var response = greeting || 'Hello World!';
      return 'googleplus-timeline says, ' + response;
    },

    /**
    * Convert a given posts timestamp of post lists to a human readable date
    *
    */
    _changeTime: function(index){
      var date = new Date(this.timeline_posts[index].published);
      var updated_date = new Date(this.timeline_posts[index].updated)
      var current_date = new Date();
      var time;
      var month = ["jan","feb","mar","apr", "may","jun","jul","aug","sep","oct","nov","dec"];
      /* Years*/
      if ((current_date.getFullYear() - date.getFullYear()) != 0) {
        var dif = current_date.getFullYear() - date.getFullYear()
        time = date.getDate()+" "+month[date.getMonth()] + ". "+ date.getFullYear();
      /* Months */
      } else if ((current_date.getMonth() - date.getMonth()) != 0) { 
        var dif = current_date.getMonth() - date.getMonth();
        time = date.getDate()+" "+month[date.getMonth()] + ". "+ date.getFullYear();
      /* Days */
      } else if((current_date.getDate() - date.getDate()) == 0 ){
        if((current_date.getHours() - date.getHours()) == 0 ){
          if( (current_date.getMinutes() - date.getMinutes()) == 0 ){
            time = current_date.getSeconds() - date.getSeconds();
            time += time == 1? " second": " seconds";
          }
          else{
            time = current_date.getMinutes() - date.getMinutes();
            time += time == 1? " minute":  " minutes";
          }
        }
        else{
          if (current_date.getHours() - date.getHours() == 1) {
            time = current_date.getHours() - date.getHours()+" hour";
          }else {
            time = current_date.getHours() - date.getHours()+" hours";
          }
        }
      }
      else if( ((current_date.getDate() - date.getDate()) < 8) && ( (current_date.getDate() - date.getDate()) > 0)){
        if( (current_date.getDate() - date.getDate()) == 1){
          time = current_date.getDate() - date.getDate()+ " day";
        }
        else{
          time = current_date.getDate() - date.getDate()+ " days";
        }
      }
      else{
        time = date.getDate()+" "+month[date.getMonth()] + ". "+ date.getFullYear();
      }
      // 
      this.set("timeline_posts." + index + ".published_pretty", time);
      this.set("timeline_posts." + index + ".published", date.getTime());
      this.set("timeline_posts." + index + ".updated", updated_date.getTime());
    },


    _sortPosts: function(post1, post2) {
      if (post1.published == post2.published)
        return 0;
      else
        return post1.published > post2.published ? -1 : 1;
    },

    // Auxiliar functions for dom-if conditions

    _hasAttachment: function(item, attachmentType){
      // if (item.object.attachments[0].objectType === "article"){
      //   console.log("Titular " + item.object.attachments[0].displayName);
      //   console.log("Subtitulo " + item.object.attachments[0].content);
      // }
      return item.object.attachments[0].objectType === attachmentType;
    },

    _hasVideoAttachment: function(item){
      return item.object.attachments[0].objectType === 'video'
      && item.object.attachments[0].hasOwnProperty('embed');
    },

    _isSharedPost: function(item){
      return item.verb === "share";
    }
  });

</script>
